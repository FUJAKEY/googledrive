# CloudDrive

CloudDrive — полнофункциональный клон Google Drive с современным интерфейсом, облачной архитектурой и продуманной мобильной адаптацией. Проект реализован на TypeScript и разделён на два приложения: сервер (Express + Prisma + SQLite) и клиент (React + Vite + Tailwind CSS).

## Основные возможности

- Регистрация, авторизация, обновление и завершение сессий на основе JWT и refresh-токенов (httpOnly cookie).
- Шифрование паролей с помощью bcrypt, защита API через Helmet, CORS, rate-limit и Zod-валидацию.
- Управление файлами и папками: загрузка (drag & drop, множественные) с очередью и прогресс-барами, пакетное скачивание, переименование, перемещение между папками, удаление, корзина и восстановление.
- Публичный шаринг с выбором прав (view/edit) и сроком действия ссылок.
- Поиск по имени, фильтрация по типу, сортировка, хлебные крошки и переключение режимов отображения (список/плитка).
- Просмотр изображений, текстовых файлов/markdown и PDF без скачивания.
- История активности (загрузка, удаление, восстановление, шаринг) в боковой панели.
- Полная адаптация под мобильные устройства: нижняя навигация с safe-area, быстрые действия, крупные интерактивные элементы, отзывчивые сетки.

## Технологический стек

- **Backend:** Node.js 18+, Express, TypeScript, Prisma, SQLite, Zod, bcrypt, JWT.
- **Frontend:** React 18, TypeScript, Vite, Tailwind CSS, React Query, React Hook Form, React Hot Toast.
- **Хранение файлов:** локальная файловая система (`/data`) через абстракцию `StorageProvider` (готово к замене на S3).
- **Тестирование:** Vitest + Supertest (smoke-тесты ключевых эндпоинтов).
- **Инфраструктура:** ESLint, Prettier, Husky pre-commit hook, Dockerfile для production-сборки.

## Структура репозитория

```
.
├── client/           # фронтенд (React + Vite + Tailwind)
├── server/           # бекенд (Express + Prisma + SQLite)
├── data/             # директория хранения файлов (создаётся автоматически)
├── .env.example      # пример переменных окружения
├── Dockerfile        # мультистейдж сборка приложения
└── README.md
```

## Переменные окружения

Скопируйте `.env.example` в `.env` и при необходимости скорректируйте значения.

| Переменная | Назначение | Значение по умолчанию |
|------------|------------|------------------------|
| `PORT` | Порт HTTP-сервера | `8000` |
| `BASE_URL` | Базовый URL сервера | `http://localhost:8000` |
| `DATABASE_URL` | Строка подключения Prisma (SQLite) | `file:./dev.db` (опционально, по умолчанию будет создана `file:/data/clouddrive.db`) |
| `JWT_SECRET` | Секрет для access-токена | `super-secret-access-token` |
| `JWT_REFRESH_SECRET` | Секрет для refresh-токена | `super-secret-refresh-token` |
| `ACCESS_TOKEN_TTL_MINUTES` | Время жизни access-токена | `15` |
| `REFRESH_TOKEN_TTL_DAYS` | Время жизни refresh-токена | `7` |
| `MAX_UPLOAD_MB` | Максимальный размер загружаемого файла | `25` |
| `STORAGE_ROOT` | Папка для хранения файлов | `./data` |
| `CORS_ORIGIN` | Разрешённые источники CORS | `http://localhost:5173` |
| `RATE_LIMIT_MAX` | Максимум запросов за 15 минут | `200` |
| `TRUST_PROXY` | Значение для `app.set('trust proxy')` (число hop'ов, `true/false` или строка правил) | `0` |
| `VITE_API_BASE_URL` | Базовый URL API на фронтенде | `http://localhost:8000` |

## Команды

Запускаются из корня репозитория.

```bash
# Установка зависимостей (server + client)
npm install

# Запуск приложений в режиме разработки (Vite + Nodemon)
npm run dev

# Сборка клиентской и серверной части
npm run build

# Запуск production-сборки (предварительно npm run build)
npm start

# Применение миграций базы данных
npm run prisma:migrate

# Запуск линтеров (ESLint для server и client)
npm run lint

# Тестирование API (Vitest + Supertest)
npm test
```

## API

Все эндпоинты начинаются с `/api`, если не указано иное.

### Аутентификация
- `POST /api/auth/register` — регистрация нового пользователя.
- `POST /api/auth/login` — авторизация и выдача токенов.
- `POST /api/auth/refresh` — обновление access-токена по refresh-cookie.
- `POST /api/auth/logout` — завершение сессии и очистка cookie.

### Работа с файлами и папками
- `GET /api/drive/list?parentId=&search=&type=&trashed=&sort=&order=` — список элементов текущей папки, поддерживает поиск, фильтрацию и сортировку.
- `POST /api/drive/folder` — создание папки (`{ name, parentId? }`).
- `POST /api/drive/file` — загрузка файлов (multipart form-data, поле `files`).
- `PATCH /api/drive/:id` — переименование или перемещение (`{ name?, parentId? }`).
- `DELETE /api/drive/:id` — перемещение в корзину.
- `DELETE /api/drive/:id?hard=true` — удаление безвозвратно.
- `POST /api/drive/:id/restore` — восстановление из корзины.
- `GET /api/drive/:id/download` — скачивание файла.
- `POST /api/drive/archive` — формирование ZIP-архива из выбранных элементов (`{ ids: string[] }`).

### Шаринг
- `POST /api/share/:id` — создание публичной ссылки (права и срок действия в теле запроса).
- `GET /api/share` — список всех созданных ссылок пользователя.
- `DELETE /api/share/:shareId` — отзыв публичной ссылки.
- `GET /s/:token` — публичный доступ к расшаренному элементу и списку дочерних файлов.
- `GET /s/:token/download` — скачивание расшаренного файла.

Сервер формирует публичные ссылки исходя из фактического хоста входящего запроса (учитываются `X-Forwarded-*` заголовки), поэтому домен в урлах автоматически соответствует текущему окружению.

### Активность
- `GET /api/activity` — последние операции пользователя.

## Docker

Проект готов к запуску в контейнере.

```bash
# Сборка образа
docker build -t clouddrive .

# Запуск контейнера на порту 8000
docker run --env-file .env -p 8000:8000 clouddrive
```

Dockerfile собирает фронтенд, переносит статические файлы в `server/public` и запускает production-сервер Express.

## Тесты

В `server/tests` реализованы smoke-тесты основных сценариев: регистрация/логин/refresh и базовые операции диска (создание папки, загрузка, удаление, восстановление, шаринг). Тесты используют отдельную SQLite-базу (`test.db`) и отдельную директорию для файлов.

## Husky

После `npm install` автоматически активируется `husky`-hook `pre-commit`, который запускает линтер и тесты перед фиксацией изменений.

## Дополнительно

- Все файлы хранятся в директории `data` (можно изменить переменной `STORAGE_ROOT`).
- Для миграций используется Prisma (`server/prisma`). Базовая миграция создаётся командой `npm run prisma:migrate`.
- Сервер автоматически раздаёт production-сборку клиента из `server/public`.

CloudDrive полностью готов к развёртыванию и дальнейшему расширению — подключение S3, многопользовательский шаринг, превью офисных документов и другие расширения могут быть добавлены поверх существующей архитектуры.
